/**
 start running capture
 */
- (void)startRunning {
    if(![self.session isRunning]){
        [self.session startRunning];
    }
    if(self.qrCodesButtonArray.count){//ç§»é™¤ä¸Šä¸€æ¬¡çš„æ ‡è®°
        [self.qrCodesButtonArray enumerateObjectsUsingBlock:^(UIButton *button, NSUInteger idx, BOOL *stop) {
            [button removeFromSuperview];
        }];
        self.qrCodesButtonArray = [NSMutableArray new];
        self.reScanButton.hidden = YES;
    }
    

}
/**
 stop running capture
 */
- (void)stopRunning {
    // reload animation on mainThread
    
    WeakSelf
    dispatch_async(dispatch_get_main_queue(), ^{
        [weakSelf.session stopRunning];
    });
}

- (AVCaptureSession *)session {
    if (!_session) {
        //1.è·å–è¾“å…¥è®¾å¤‡ï¼ˆæ‘„åƒå¤´ï¼‰
        AVCaptureDevice *device = [AVCaptureDevice defaultDeviceWithMediaType:AVMediaTypeVideo];
        //2.æ ¹æ®è¾“å…¥è®¾å¤‡åˆ›å»ºè¾“å…¥å¯¹è±¡
        AVCaptureDeviceInput *input = [AVCaptureDeviceInput deviceInputWithDevice:device error:NULL];
        if (input == nil) {
            return nil;
        }
        //3.åˆ›å»ºå…ƒæ•°æ®çš„è¾“å‡ºå¯¹è±¡
        AVCaptureMetadataOutput *output = [[AVCaptureMetadataOutput alloc]init];
        //4.è®¾ç½®ä»£ç†ç›‘å¬è¾“å‡ºå¯¹è±¡è¾“å‡ºçš„æ•°æ®,åœ¨ä¸»çº¿ç¨‹ä¸­åˆ·æ–°
        [output setMetadataObjectsDelegate:self queue:dispatch_get_main_queue()];
        // 5.åˆ›å»ºä¼šè¯(æ¡¥æ¢)
        AVCaptureSession *session = [[AVCaptureSession alloc]init];
        //å®ç°é«˜è´¨é‡çš„è¾“å‡ºå’Œæ‘„åƒï¼Œé»˜è®¤å€¼ä¸ºAVCaptureSessionPresetHighï¼Œå¯ä»¥ä¸å†™
        [session setSessionPreset:AVCaptureSessionPresetHigh];
        // 6.æ·»åŠ è¾“å…¥å’Œè¾“å‡ºåˆ°ä¼šè¯ä¸­ï¼ˆåˆ¤æ–­sessionæ˜¯å¦å·²æ»¡ï¼‰
        if ([session canAddInput:input]) {
            [session addInput:input];
        }
        if ([session canAddOutput:output]) {
            [session addOutput:output];
        }

        // 7.å‘Šè¯‰è¾“å‡ºå¯¹è±¡, éœ€è¦è¾“å‡ºä»€ä¹ˆæ ·çš„æ•°æ® (äºŒç»´ç è¿˜æ˜¯æ¡å½¢ç ç­‰) è¦å…ˆåˆ›å»ºä¼šè¯æ‰èƒ½è®¾ç½®
        output.metadataObjectTypes = @[AVMetadataObjectTypeQRCode,AVMetadataObjectTypeCode128Code,AVMetadataObjectTypeCode93Code,AVMetadataObjectTypeCode39Code,AVMetadataObjectTypeCode39Mod43Code,AVMetadataObjectTypeEAN8Code,AVMetadataObjectTypeEAN13Code,AVMetadataObjectTypeUPCECode,AVMetadataObjectTypePDF417Code,AVMetadataObjectTypeAztecCode];

        // 8.åˆ›å»ºé¢„è§ˆå›¾å±‚
        AVCaptureVideoPreviewLayer *previewLayer = [AVCaptureVideoPreviewLayer layerWithSession:session];
        [previewLayer setVideoGravity:AVLayerVideoGravityResizeAspectFill];
        previewLayer.frame = self.cameraView.bounds;
        [self.cameraView.layer insertSublayer:previewLayer atIndex:0];

        //9.è®¾ç½®æœ‰æ•ˆæ‰«æåŒºåŸŸï¼Œé»˜è®¤æ•´ä¸ªå›¾å±‚(å¾ˆç‰¹åˆ«ï¼Œ1ã€è¦é™¤ä»¥å±å¹•å®½é«˜æ¯”ä¾‹ï¼Œ2ã€å…¶ä¸­xå’Œyã€widthå’Œheightåˆ†åˆ«äº’æ¢ä½ç½®)
//        CGRect rect = CGRectMake(kBgImgY/ScreenHeight, kBgImgX/ScreenWidth, kBgImgWidth/ScreenHeight, kBgImgWidth/ScreenWidth);

        _session = session;
    }
    return _session;
}

#pragma mark AVCaptureMetadataOutputObjectsDelegate
- (void)captureOutput:(AVCaptureOutput *)captureOutput didOutputMetadataObjects:(NSArray *)metadataObjects fromConnection:(AVCaptureConnection *)connection{
    if ([metadataObjects count] >0){
        NSLog(@"========æ‰«æåçš„urlæ˜¯:==============");
        NSMutableArray *muchArray = [NSMutableArray new];
        [metadataObjects enumerateObjectsUsingBlock:^(AVMetadataMachineReadableCodeObject *obj, NSUInteger idx, BOOL *stop) {
            if ([obj.type isEqualToString:AVMetadataObjectTypeQRCode]) {   //åˆ¤æ–­æ˜¯å¦æœ‰æ•°æ®ï¼Œæ˜¯å¦æ˜¯äºŒç»´ç æ•°æ®
                [muchArray addObject:obj];
            }
        }];
        [self stopRunning];// æˆ‘è¿™é‡Œæ˜¯æ‰«ç åˆ°ç»“æœå°±æš‚åœæ‰«ç ã€åŠ ä¸ªé‡æ–°æ‰«æbtnä¼šç”¨æˆ·å‹å¥½ä¸€ç‚¹ï¼Œåé¢æ˜¯å¤„ç†æ‰«ç ç»“æœ
        
        if([muchArray count] == 1){//æ‰«æåˆ°ä¸€ä¸ªäºŒç»´ç ä¿¡æ¯
            AVMetadataMachineReadableCodeObject * metadataObject = [muchArray objectAtIndex:0];
            NSString *stringValue = metadataObject.stringValue;
            
            self.urlString = stringValue.length?stringValue:@"";
            
            NSLog(@" 1111æ‰«æåçš„urlæ˜¯:%@",self.urlString);
            if(self.urlString.length){
                
                dispatch_async(dispatch_get_main_queue(), ^{
                    [self analyseResultAry:self.urlString];
                    self.reScanButton.hidden = NO;
                });
            }
        }else if([muchArray count] >1){// å¤šä¸ªäºŒç»´ç ä¿¡æ¯ æ˜¾ç¤ºäºŒç»´ç å®šä½é¡µé¢  é€‰æ‹©è·³è½¬
            self.qrCodesArray = [NSMutableArray new];
            [muchArray enumerateObjectsUsingBlock:^(AVMetadataMachineReadableCodeObject *result, NSUInteger idx, BOOL *stop) {
                NSMutableDictionary *dic = [NSMutableDictionary new];
                NSString *code = result.stringValue;
                [dic setObject:code forKey:@"code"];
                
                NSLog(@"2222 æ‰«æåçš„urlæ˜¯:%@",code);
                
                // æ ‡æ³¨å¤šä¸ªäºŒç»´ç 
                CGRect frame = [self makeFrameWithCodeObject:result Index:self.qrCodesArray.count];
                NSString *frameStr = NSStringFromCGRect(frame);
                [dic setObject:frameStr forKey:@"frame"];
                [self.qrCodesArray addObject:dic];//è®°å½•ä¸‹æ ‡æ³¨çš„æ•°ç»„ï¼Œä¸‹æ¬¡æ‰«ç ç§»é™¤å‰é¢çš„æ ‡æ³¨
            }];
            
            dispatch_async(dispatch_get_main_queue(), ^{
                self.reScanButton.hidden = NO;
            });
        }
    }
}
//é€‰æ‹©å¤šä¸ªäºŒç»´ç ä¸­çš„ä¸€ä¸ª
- (void)handleBtnAction:(UIButton *)sender {
    NSInteger index = sender.tag - 1000;
    if (index < self.qrCodesArray.count) {
        NSDictionary *dic = self.qrCodesArray[index];
        if([dic.allKeys containsObject:@"code"]){
            self.urlString = [dic objectForKey:@"code"]?[dic objectForKey:@"code"]:@"";
            NSLog(@"2222 æ‰«æåçš„urlæ˜¯: é€‰ä¸­ %@",self.urlString);
            if(self.urlString.length){
                [self analyseResultAry:self.urlString];
            }
        }
    }
}

//é‡æ–°æ‰«ç 
-(void)reScanBtnAction:(UIButton *)sender {
    [self startRunning];
}

/*
 AVMetadataMachineReadableCodeObjectï¼Œè¾“å‡ºçš„ç‚¹ä½åæ ‡æ˜¯å…¶åœ¨åŸå§‹æ•°æ®æµä¸Šçš„åæ ‡ï¼Œä¸å±å¹•è§†å›¾åæ ‡ä¸ä¸€æ ·ï¼Œï¼ˆåæ ‡ç³»ï¼Œå€¼éƒ½ä¼šæœ‰å·®åˆ«ï¼‰
 å°†åæ ‡å€¼è½¬ä¸ºå±å¹•æ˜¾ç¤ºçš„å›¾åƒè§†å›¾ï¼ˆself.videoPreviewLayerï¼‰ä¸Šçš„åæ ‡å€¼
 */
-(CGRect)makeFrameWithCodeObject:(AVMetadataMachineReadableCodeObject *)objc Index:(NSInteger)index
{
    //å°†äºŒç»´ç åæ ‡è½¬åŒ–ä¸ºæ‰«ç æ§ä»¶è¾“å‡ºè§†å›¾ä¸Šçš„åæ ‡
    //     CGSize isize = CGSizeMake(720.0, 1280.0); // å°ºå¯¸å¯ä»¥è€ƒè™‘ä¸è¦å†™æ­»,å½“å‰è®¾ç½®çš„æ˜¯captureSession.sessionPreset = AVCaptureSessionPreset1280x720;
    CGSize isize = self.cameraView.frame.size; //æ‰«ç æ§ä»¶çš„è¾“å‡ºå°ºå¯¸ï¼Œ
    float Wout = 0.00;
    float Hout = 0.00;
    BOOL wMore = YES;
    /*å–åˆ†è¾¨ç‡ä¸è¾“å‡ºçš„layerå°ºå¯¸å·®ï¼Œ
     æ­¤å¤„ä»¥AVLayerVideoGravityResizeAspectFillå¡«å……æ–¹å¼ä¸ºä¾‹ï¼Œåˆ¤æ–­æ‰«æçš„èŒƒå›´æ›´å®½è¿˜æ˜¯æ›´é•¿ï¼Œå¹¶è®¡ç®—å‡ºè¶…å‡ºéƒ¨åˆ†çš„å°ºå¯¸ï¼Œåç»­è®¡ç®—å‡å»è¿™éƒ¨åˆ†ã€‚
     å¦‚æœæ˜¯å…¶å®ƒå¡«å……æ–¹å¼ï¼Œè®¡ç®—æ–¹å¼ä¸ä¸€æ ·ï¼ˆæ¯”å¦‚AVLayerVideoGravityResizeAspectï¼Œåˆ™è®¡ç®—è®¡ç®—ç•™ç™½çš„å°ºå¯¸ï¼Œå¹¶åç»­è¡¥è¶³è¿™éƒ¨åˆ†ï¼‰
     */
    if (isize.width/isize.height > self.cameraView.bounds.size.width/self.cameraView.bounds.size.height) {
        //å½“æ›´å®½æ—¶ï¼Œè®¡ç®—æ‰«æçš„åæ ‡xä¸º0 çš„ç‚¹æ¯”è¾“å‡ºè§†å›¾çš„0ç‚¹å·®å¤šå°‘ï¼ˆè¾“å‡ºè§†å›¾ä¸ºå…¨å±æ—¶ï¼Œå³å±å¹•å¤–æœ‰å¤šå°‘ï¼‰
        wMore = YES;
        Wout = (isize.width/isize.height)* self.cameraView.bounds.size.height;
        Wout = Wout - self.cameraView.bounds.size.width;
        Wout = Wout/2;
    }else{
        // å½“æ›´é•¿æ—¶ï¼Œè®¡ç®—yè½´è¶…å‡ºå¤šå°‘ã€‚
        wMore = NO;
        Hout = (isize.height/isize.width)* self.cameraView.bounds.size.width;
        Hout = Hout  - self.cameraView.bounds.size.height;
        Hout = Hout/2;
    }
    
    CGPoint point1 = CGPointZero;
    CGPoint point2 = CGPointZero;
    CGPoint point3 = CGPointZero;
    CGPoint point4 = CGPointZero;
    /*
     æºåæ ‡ç³»ä¸‹frameå’Œè§’ç‚¹ï¼Œéƒ½æ˜¯æ¯”ä¾‹å€¼ï¼Œå³æºè§†é¢‘æµå°ºå¯¸ä¸‹çš„ç™¾åˆ†æ¯”å€¼ã€‚
     ä¾‹å­ï¼šframe ï¼š(x = 0.26720550656318665, y = 0.0014114481164142489), size = (width = 0.16406852006912231, height = 0.29584407806396484))
     objc.cornersï¼š{0.26823519751360592, 0.29203594744002659}
     {0.4312740177700658, 0.29725551905635411}
     {0.4294213439632073, 0.012761536345436197}
     {0.26720551457151021, 0.0014114481640513654}
     */
    CGRect frame = objc.bounds;//åœ¨æºåæ ‡ç³»çš„frameï¼Œ
    NSArray *array = objc.corners;//æºåæ ‡ç³»ä¸‹äºŒç»´ç çš„è§’ç‚¹
    CGPoint P = frame.origin;
    CGSize S = frame.size;
    
    //è·å–ç‚¹
    for (int n = 0; n< array.count; n++) {
        
        CGPoint point = CGPointZero;
        CFDictionaryRef dict = (__bridge CFDictionaryRef)(array[n]);
        CGPointMakeWithDictionaryRepresentation(dict, &point);
//        NSLog(@"äºŒç»´ç è§’ç‚¹%@",NSStringFromCGPoint(point));
        //äº¤æ¢xyè½´
        point.x = point.y +  point.x;
        point.y = point.x - point.y;
        point.x = point.x - point.y;
        //xè½´åè½¬
        point.x = (1-point.x);
        //pointä¹˜ä»¥æ¯”åˆ—ã€‚å‡å»å°ºå¯¸å·®ï¼Œ
        if (wMore) {
            point.x = (point.x * (isize.width/isize.height)* self.cameraView.bounds.size.height) - Wout;
            point.y = self.cameraView.bounds.size.height *(point.y);
        }else{
            point.x = self.cameraView.bounds.size.width *(point.x);
            point.y = (point.y) * (isize.height/isize.width)* self.cameraView.bounds.size.width - Hout;
        }
        if (n == 0) {
            point1 = point;
        }
        if (n == 1) {
            point2 = point;
        }
        if (n == 2) {
            point3 = point;
        }
        if (n == 3) {
            point4 = point;
        }
    }
    //é€šè¿‡è·å–æœ€å°å’Œæœ€å¤§çš„Xï¼ŒYå€¼ï¼ŒäºŒç»´ç åœ¨è§†å›¾ä¸Šçš„frameï¼ˆå‰é¢å¾—åˆ°çš„ç‚¹ä¸ä¸€å®šæ˜¯æ­£æ–¹å½¢çš„äºŒç»´ç ï¼Œä¹Ÿå¯èƒ½æ˜¯è±å½¢çš„æˆ–è€…æœ‰ä¸€å®šæ—‹è½¬è§’åº¦çš„ï¼‰
    float minX = point1.x;
    minX = minX>point2.x?point2.x:minX;
    minX = minX>point3.x?point3.x:minX;
    minX = minX>point4.x?point4.x:minX;
    
    float minY = point1.y;
    minY = minY>point2.y?point2.y:minY;
    minY = minY>point3.y?point3.y:minY;
    minY = minY>point4.y?point4.y:minY;
    P.x = minX;
    P.y = minY;
    
    float maxX = point1.x;
    maxX = maxX<point2.x?point2.x:maxX;
    maxX = maxX<point3.x?point3.x:maxX;
    maxX = maxX<point4.x?point4.x:maxX;
    
    float maxY = point1.y;
    maxY = maxY<point2.y?point2.y:maxY;
    maxY = maxY<point3.y?point3.y:maxY;
    maxY = maxY<point4.y?point4.y:maxY;
    
    S.width = maxX - minX;
    S.height = maxY - minY;
    
    //yè½´åæ ‡æ–¹å‘è°ƒæ•´
    CGRect QRFrame = CGRectMake(P.x , P.y  , S.width, S.height);
    
    UIButton *tempButton = [UIButton buttonWithType:UIButtonTypeCustom];//å¤šä¸ªäºŒç»´ç æ·»åŠ é€‰æ‹©btn
    tempButton.backgroundColor = [UIColor blueColor];
    tempButton.frame = QRFrame;
    [self.cameraView addSubview:tempButton];
    tempButton.tag = 1000 + index;
    [tempButton addTarget:self action:@selector(handleBtnAction:) forControlEvents:UIControlEventTouchUpInside];
    [self.qrCodesButtonArray addObject:tempButton];
    
    return QRFrame;
}

-(void)analyseResultAry:(NSString *)resultAsString{
    WeakSelf
    [[AFNetworkReachabilityManager sharedManager] startMonitoring];
    [[AFNetworkReachabilityManager sharedManager] setReachabilityStatusChangeBlock:^(AFNetworkReachabilityStatus status) {
        [[AFNetworkReachabilityManager sharedManager] stopMonitoring];
        if (status >= 1) {
            // æœ‰ç½‘ç»œ
            if (resultAsString.length) {
              //  ç»“æœå¹²ç‚¹å•¥~~~~ğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜Š
            } else {
                NSLog(@"è¯†åˆ«ç»“æœå†…å®¹ï¼šä¸ºç©º");
                [weakSelf stopRunning];
            }
        } else {
            NSLog(@"æ²¡æœ‰ç½‘ç»œ");
            [weakSelf stopRunning];
        }
    }];
}

